<!DOCTYPE html>
<html>
<head>
    <title>
Raspberry Pi Temperature Logger
    </title>

    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript">
      google.load("visualization", "1", {packages:["corechart"]});
      google.setOnLoadCallback(updateInfo);

      // http://stackoverflow.com/a/35970894/2454476
      var getJSON = function(url, callback) {
        var xhr = new XMLHttpRequest();
        xhr.open("get", url, true);
        xhr.responseType = "json";
        xhr.onload = function() {
          var status = xhr.status;
          if (status == 200) {
            callback(null, xhr.response);
          } else {
            callback(status);
          }
        };
        xhr.send();
      };

      function updateInfo() {
        getJSON("/temperature/data.json",
        function(err, data) {
          if (err != null) {
            //alert("Something went wrong: " + err);
          } else {
            //alert("Your query count: " + data.query.count);
            drawChart(data.rows);
            updateStats(data);
          }
        });
      }

      var graphTimer = window.setInterval(updateInfo, 120000); // update every 120 seconds

      var statsTableId = 0;

      function updateStats(jsondata) {

        min = jsondata.min;
        max = jsondata.max;
        avg = jsondata.avg;

        document.getElementById("min_timestamp").textContent = min[0][0];
        document.getElementById("min_temp").textContent = min[0][1];
        document.getElementById("max_timestamp").textContent = max[0][0];
        document.getElementById("max_temp").textContent = max[0][1];
        document.getElementById("avg_temp").textContent = avg[0][1];
        
        var oldTable = document.getElementById("statstable" + statsTableId);
        var newTable = buildHtmlTable(jsondata.rows);
        newTable.id = "statstable" + ++statsTableId;
        oldTable.parentNode.replaceChild(newTable, oldTable);

        // Builds the HTML Table out of myList json data from Ivy restful service.
        function buildHtmlTable(arr) {
          var table = document.createElement('table');
          var columns = addAllColumnHeaders(arr, table);
          for (var i=1, maxi=arr.length; i < maxi; ++i) {
            var tr = document.createElement('tr');
            for (var j=0, maxj=columns.length; j < maxj ; ++j) {
              var td = document.createElement('td');
              cellValue = arr[i][columns[j]];
              td.appendChild(document.createTextNode((arr[i][columns[j]] || '') + '\xa0\xa0\xa0\xa0')); // &nbsp;
              tr.appendChild(td);
            }
            table.appendChild(tr);
          }
          return table;
        }

        // Adds a header row to the table and returns the set of columns.
        // Need to do union of keys from all records as some records may not contain
        // all records
        function addAllColumnHeaders(arr, table)
        {
          var columnSet = [],
          tr = document.createElement('tr');
          for (var i=0, l=arr.length; i < l; i++) {
            for (var key in arr[i]) {
              if (arr[i].hasOwnProperty(key) && columnSet.indexOf(key)===-1) {
                columnSet.push(key);
                var th = document.createElement('th');
                //th.appendChild(document.createTextNode(key));
		th.appendChild(document.createTextNode((arr[i][key] || key) + '\xa0\xa0\xa0\xa0')); // &nbsp;
                tr.appendChild(th);
              }
            }
          }
          table.appendChild(tr);
          return columnSet;
        }

      }

      function drawChart(arraydata) {
        arraydata.unshift(['Timestamp', 'Temperature']);        
        var data = google.visualization.arrayToDataTable(arraydata);
        var options = {
          title: 'Temperature'
        };
        var chart = new google.visualization.LineChart(document.getElementById('chart_div'));
        chart.draw(data, options);
      }
    </script>
</head>
<body>
<h1>Raspberry Pi Temperature Logger</h1>
<hr>
<h2>Temperature Chart</h2>
<div id="chart_div" style="width: 900px; height: 500px;"></div>
<hr>
<h2>Minumum temperature&nbsp</h2>
<span id="min_timestamp">&nbsp;</span>&nbsp;&nbsp;&nbsp;<span id="min_temp">&nbsp;</span>
<h2>Maximum temperature</h2>
<span id="max_timestamp">&nbsp;</span>&nbsp;&nbsp;&nbsp;<span id="max_temp">&nbsp;</span>
<h2>Average temperature</h2>
<span id="avg_temp">&nbsp;</span>
<hr>
<h2>In the last hour:</h2>
<table id="statstable0">
</table>
<hr>
</body>
</html>
